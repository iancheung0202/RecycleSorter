<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <title>RecycleSorter</title>
    <style>
        @font-face {
            font-family: nougat;
            src: url(Nougat-ExtraBlack.ttf);
        }
		main {
            font-family: nougat;
			margin: 0;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}
        body {
            background-color: black;
            color: white;
        }
        .light-mode {
            background-color: white;
            color: black;
        }
		#title {
            font-size: 50px;
        }
        .btn {
            justify-content: center;
            font-size: 30px;
            border: 1px solid white;
            padding: 10px;
            border-radius: 5px;
            transition: .2s;
            display: inline;
            margin-top: 100px;
            margin-bottom: 100px;
        }
        .btn.light-mode {
            border: 1px solid black;
        }
        .btn.light-mode:hover {
            background-color: black;
        }
        .btn:hover {
            background-color: white;
            color: black;
            cursor: pointer;
        }
        canvas {
            border-radius: 10px;
            margin-bottom: 50px;
        }
        #label-container {
            margin-top: 30px;
        }
        h1 {
            opacity: 1;
            animation: fade 1s linear;
        }
        #startSorting {
            opacity: 1;
            animation: fade 2s linear;
        }
        @keyframes fade {
            0%, 50%{ opacity: 0 }
            100% { opacity: 1 }
        }
        i {
            font-family: Arial, Helvetica, sans-serif !important;
        }
    </style>
</head>

<body>
    <header>
        <button onclick="toggleMode()" style="position: absolute;right:5;top:5;">Toggle dark mode</button>
    </header>
    <main>
        <div id="startScreen">
            <div id="title"><h1 data-aos="fade-left">RecycleSorter</h1></div>
            <span class="btn" onclick="init('environment')" id="startSorting">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg> Start Sorting</span>
        </div>
        <div id="sortScreen" style="visibility: hidden; display: none;">
            <div id="webcam-container"></div>
            <div id="sortBtn" style="visibility: hidden;"><span class="btn" onclick="predict()"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-display" viewBox="0 0 16 16"> <path d="M0 4s0-2 2-2h12s2 0 2 2v6s0 2-2 2h-4c0 .667.083 1.167.25 1.5H11a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1h.75c.167-.333.25-.833.25-1.5H2s-2 0-2-2V4zm1.398-.855a.758.758 0 0 0-.254.302A1.46 1.46 0 0 0 1 4.01V10c0 .325.078.502.145.602.07.105.17.188.302.254a1.464 1.464 0 0 0 .538.143L2.01 11H14c.325 0 .502-.078.602-.145a.758.758 0 0 0 .254-.302 1.464 1.464 0 0 0 .143-.538L15 9.99V4c0-.325-.078-.502-.145-.602a.757.757 0 0 0-.302-.254A1.46 1.46 0 0 0 13.99 3H2c-.325 0-.502.078-.602.145z"/> </svg> Sort</span>&nbsp;&nbsp;&nbsp;<span class="btn" id="flipCamera" onclick="init('${next}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16"> <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/> <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1zm9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0z"/> </svg> Flip Camera</span></div>
            <div id="label-container"></div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script type="text/javascript">
        startScreen = document.getElementById("startScreen");
        sortScreen = document.getElementById("sortScreen");
        
        const URL = "https://teachablemachine.withgoogle.com/models/CgTV5zJeZ/";

        let model, webcam, labelContainer, maxPredictions;

        // Load the image model and setup the webcam
        async function init(arg) {

            while (document.getElementById("webcam-container").firstChild) {
                document.getElementById("webcam-container").removeChild(document.getElementById("webcam-container").firstChild);
            } // Remove all previous webcams

            document.getElementById("webcam-container").innerHTML = `
        <img src="loading.gif" height="40px" width="40px" />` // Loading Icon

            startScreen.style.visibility = "hidden";
            startScreen.style.display = "none";
            sortScreen.style.visibility = "visible";
            sortScreen.style.display = "block";

            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // const isMobile = navigator.userAgentData.mobile;
            // console.log(isMobile);
            // if (isMobile) {
            //     alert("You are using mobile!");
            // }
            const flip = false;
            var next = 'self';
            // if (isMobile) {
            //     flip = false;
            // } 
            webcam = new tmImage.Webcam(300, 300, flip); // width, height, flip
            if (arg == 'environment') {
                await webcam.setup({facingMode: "environment"}); // request access to the webcam
                
            } else if (arg == 'self') {
                await webcam.setup();
                next = 'environment';
            }
            await webcam.play();
            window.requestAnimationFrame(loop);

            // append elements to the DOM
            document.getElementById("webcam-container").innerHTML = ""
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            document.getElementById("sortBtn").style.visibility = "visible";
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) { // and class labels
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop() {
            webcam.update(); // update the webcam frame
            // await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            const probabilities = [];
            for (let i = 0; i < maxPredictions; i++) {
                // const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                // labelContainer.childNodes[i].innerHTML = classPrediction;
                const classPrediction = probabilities.push(prediction[i].probability)
            }
            largestProbability = Math.max.apply(Math, probabilities)
            const index = probabilities.indexOf(largestProbability);
            labelContainer.innerHTML = prediction[index].className + ": " + prediction[index].probability.toFixed(2)*100 + "%";;
        }
    </script>
    <script>
        function toggleMode() {
            var element = document.body;
            element.classList.toggle("light-mode");
            var messages = document.querySelectorAll(".btn");

            messages.forEach(message => {
                message.classList.toggle("light-mode");
            });
        }
    </script>
</body>
</html>
